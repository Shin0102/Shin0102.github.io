---
title: "Axon Framework ì•Œì•„ë³´ê¸°"
subtitle: "Axon ë¼ì´ë¸ŒëŸ¬ë¦¬ ì •ë¦¬ ë° ì£¼ìš” ê°œë…"
date: 2025-04-11
description:
  - "Event Sourcingê³¼ CQRSë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•œ Axon Frameworkì˜ í•µì‹¬ ê¸°ëŠ¥ê³¼ ì‚¬ìš©ë²•ì„ ì •ë¦¬í•©ë‹ˆë‹¤."
image: images/axon-library/axon-framework.png
meta_image: images/axon-library/axon-framework.png
tags:
  - axon
  - event sourcing
  - cqrs
  - microservices
  - java
  - kotlin
categories:
  - msa
---

## ë“¤ì–´ê°€ë©°

---

&nbsp;&nbsp;&nbsp;ìµœê·¼ Event Sourcingê³¼ CQRS íŒ¨í„´ì— ëŒ€í•´ í•™ìŠµí•˜ê²Œ ë˜ë©´ì„œ Axon Frameworkë¥¼ ì ‘í•˜ê²Œ ë˜ì—ˆë‹¤. ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ë°ì´í„° ì¼ê´€ì„± ë¬¸ì œë¥¼ í•´ê²°í•˜ê³ , í™•ì¥ ê°€ëŠ¥í•œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ë¥¼ êµ¬í˜„í•˜ëŠ”ë° ë„ì›€ì´ ë˜ëŠ” Java/Kotlin ê¸°ë°˜ í”„ë ˆì„ì›Œí¬ë‹¤. ì´ ê¸€ì—ì„œëŠ” Axon Frameworkì˜ ì£¼ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©ë²•ê³¼ í•µì‹¬ ê°œë…ë“¤ì„ ì •ë¦¬í•´ë³´ë ¤ í•œë‹¤.

## Axon Server

---

&nbsp;&nbsp;&nbsp;Axon ServerëŠ” ì´ë²¤íŠ¸ ìŠ¤í† ì–´ì™€ ë©”ì‹œì§€ ë¼ìš°íŒ…ì„ ë‹´ë‹¹í•˜ëŠ” í•µì‹¬ ì»´í¬ë„ŒíŠ¸ë‹¤.

### ë°°í¬ ì „ëµ

&nbsp;&nbsp;&nbsp;EC2 ì¸ìŠ¤í„´ìŠ¤ ìˆ˜ë™ ì„¸íŒ… ë°©ì‹ì„ ì±„íƒí–ˆë‹¤.

- íŒŒì¼ ê¸°ë°˜ìœ¼ë¡œ ì´ë²¤íŠ¸ë‚˜ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê¸° ë•Œë¬¸ì— persist volume(EBS) ì„¸íŒ…ì´ í•„ìš”í•˜ë‹¤
- ECS ë…¸ë“œ ì¸ìŠ¤í„´ìŠ¤ì— EBSë¥¼ ì§ì ‘ ì—°ê²°í•  ìˆ˜ ì—†ë‹¤
- ìŠ¤ì¼€ì¼ë§ ì˜ë¯¸ê°€ ì œí•œì ì´ë‹¤ - íŒŒì¼ ê¸°ë°˜ stateful ì„œë²„ì´ê¸° ë•Œë¬¸ì— EFSë‚˜ NFS ë“± ë„¤íŠ¸ì›Œí¬ ê³µìœ  íŒŒì¼ì‹œìŠ¤í…œ ì‚¬ìš© ì‹œ ì„±ëŠ¥ì´ EBS ëŒ€ë¹„ ëŠë¦¬ë‹¤
- í´ëŸ¬ìŠ¤í„°ë§ êµ¬ì„± ì‹œ: 3ê°œì˜ EC2 ì¸ìŠ¤í„´ìŠ¤ + 3ê°œì˜ EBSë¡œ êµ¬ì„± (Axon Server ìì²´ì ìœ¼ë¡œ ë°ì´í„° íŒŒì¼ ë ˆí”Œë¦¬ì¼€ì´ì…˜ ìˆ˜í–‰)

### ì‚¬ìš© í¬íŠ¸

- 8024: Axon Server Management UI ì ‘ì†ì„ ìœ„í•œ HTTP í¬íŠ¸
- 8124: Axon Framework(í´ë¼ì´ì–¸íŠ¸)ì™€ Axon Server ê°„ gRPC í†µì‹  í¬íŠ¸
- 8224: Axon Server í´ëŸ¬ìŠ¤í„°ë§ ì‹œ ì„œë²„ ê°„ gRPC í†µì‹  í¬íŠ¸

## Messaging Concepts

---

&nbsp;&nbsp;&nbsp;Axonì˜ Command, Event, QueryëŠ” ëª¨ë‘ Message ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•œë‹¤.

### Message êµ¬ì¡°

```
Message<T>
â”œâ”€â”€ payload: T
â”œâ”€â”€ payloadType: Class<T>
â”œâ”€â”€ metaData: MetaData â†’ Immutable
â”œâ”€â”€ identifier: String (UUID)
```

### MetaData í™œìš©

MetaDataëŠ” traceId, correlationId ì‚½ì…, security context ë“±ì— í™œìš©ëœë‹¤.

```kotlin
originalMessage.withMetaData(mapOf("key" to "value"))  // ëŒ€ì²´
originalMessage.andMetaData(mapOf("key" to "value"))  // ì¶”ê°€
```

### Message Correlation

ì„œë¡œ ë‹¤ë¥¸ ë©”ì‹œì§€(Command, Event, Query) ê°„ì˜ ê´€ê³„ë¥¼ ì¶”ì í•˜ê¸° ìœ„í•œ ë©”ì»¤ë‹ˆì¦˜ì´ë‹¤.

- Axonì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ Command ìƒì„± ì‹œ Metadataì— traceIdì™€ CorrelationId ë¶€ì—¬
- ê°™ì€ UnitOfWork ë‚´ì—ì„œ ì „íŒŒë¨
- `slf4j` MDCì™€ ì—°ë™í•˜ì—¬ Flow ì¶”ì  ê°€ëŠ¥

### Message Intercepting

ë©”ì‹œì§€ ì²˜ë¦¬ ì§ì „/ì§í›„ ì‹¤í–‰ë˜ëŠ” ê¸°ëŠ¥ìœ¼ë¡œ ë‘ ê°€ì§€ íƒ€ì…ì´ ìˆë‹¤:

- dispatch: ë©”ì‹œì§€ê°€ message handlerì— invokeë˜ê¸° ì „
- handler: ë©”ì‹œì§€ê°€ message handlerì— invokeëœ í›„

#### í™œìš© ì‚¬ë¡€

| êµ¬ë¶„ | ì„¤ëª… |
|---------|---------|
| ğŸ’¬ ë¡œê¹…/ëª¨ë‹ˆí„°ë§ | ë©”ì‹œì§€ íë¦„ ë¡œê¹…, ì´ë²¤íŠ¸ ì‹œê°í™” |
| ğŸ§  ìœ íš¨ì„± ê²€ì‚¬ | ì»¤ë§¨ë“œ/ì´ë²¤íŠ¸ ìœ íš¨ì„± ì‚¬ì „ ì²´í¬ |
| ğŸ”’ ë³´ì•ˆ í•„í„°ë§ | ì‚¬ìš©ì ì¸ì¦, ê¶Œí•œ ê²€ì¦ |
| ğŸ§­ íŠ¸ë ˆì´ì‹± | MDC / Sleuth / OpenTelemetry ì—°ë™ |
| ğŸ”„ ë©”íƒ€ë°ì´í„° ì‚½ì… | ë©”ì‹œì§€ì— ê³µí†µ ì •ë³´ ìë™ ì‚½ì… |
| ğŸ§ª í…ŒìŠ¤íŠ¸/Mock ë¼ìš°íŒ… | í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ë©”ì‹œì§€ í•„í„°ë§, ìš°íšŒ ì²˜ë¦¬ |
| ğŸ’¥ ì—ëŸ¬ ì¡°ì‘ | ì˜ˆì™¸ ë³€í™˜, ì¥ì•  ì „íŒŒ í†µì œ |

ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì—ëŸ¬ í•¸ë“¤ë§ì˜ ê²½ìš° ExceptionHandlerë¥¼ ë“±ë¡í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤:

- Command ì‹¤íŒ¨ ì‹œ ìœ ì € Response
- ë¡¤ë°± ì—¬ë¶€ ì œì–´
- DLQ ì‚¬ìš©
- ë¬´ì‹œ ë° ë‹¨ìˆœ ë¡œê¹…

### UoW(Unit of Work)

Axon ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë™ì•ˆì˜ ì „ì²´ ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ì´ì, íŠ¸ëœì­ì…˜ ê²½ê³„ì„  ì—­í• ì„ ìˆ˜í–‰í•œë‹¤.

#### UoW ìƒíƒœ íë¦„

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    STARTED   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ PREPARE_COMMITâ”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    COMMIT    â”‚â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â†“          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚ AFTER_COMMIT â”‚  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â†“          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚   CLEANUP    â”‚  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â†“          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”
        â”‚CLOSEDâ”‚   â”‚ROLLEDâ”‚
        â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜
```

#### Event Processorë³„ UoW ì»¨í…ìŠ¤íŠ¸ ë²”ìœ„

Subscribing Processor
```
Command Gateway
   â†“
@CommandHandler â†’ apply(event)
   â†“
Subscribing Event Handler
   â†“
Projection (DB write)
   â†“
UoW commit

ğŸ“Œ Projection ì‹¤íŒ¨ â†’ ì „ì²´ ë¡¤ë°±
```

Tracking Processor
```
Command Gateway
   â†“
@CommandHandler â†’ apply(event)
   â†“
UoW A â†’ COMMIT ì™„ë£Œ (Event ì €ì¥ ì™„ë£Œ)

=== ì´í›„ ===

TrackingEventProcessor ìŠ¤ë ˆë“œ
   â†“
@EventHandler ì‹¤í–‰ â†’ UoW B
   â†“
Projection
   â†“
UoW B commit

ğŸ“Œ Projection ì‹¤íŒ¨ â†’ UoW Bë§Œ rollback, ì´ë²¤íŠ¸ ì¬ì‹œë„
```

#### í™œìš© ì˜ˆì œ

afterCommit í™œìš©
```kotlin
@CommandHandler
fun handle(cmd: RegisterUserCommand, unitOfWork: UnitOfWork<*>) {
    AggregateLifecycle.apply(UserRegisteredEvent(...))

    unitOfWork.afterCommit {
        // ë©”ì¼ ë°œì†¡ íŠ¸ë¦¬ê±°
        notificationService.sendWelcomeMail(cmd.email)
    }
}
```

UoWë¥¼ í™œìš©í•˜ì—¬ ë¦¬ì†ŒìŠ¤ ê³µìœ ë„ ê°€ëŠ¥í•˜ë‹¤.

### Timeouts

Axonì—ì„œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í–ˆì„ ë•Œ, ì‘ë‹µì´ ì§€ì •ëœ ì‹œê°„ ë‚´ì— ë„ì°©í•˜ì§€ ì•Šìœ¼ë©´ ì‹¤íŒ¨ë¡œ ê°„ì£¼í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤.

- Spring Bootì—ì„œ ê¸°ë³¸ê°’: 10ì´ˆ(ë¡œê·¸ warning), 30ì´ˆ(timeout)

## Command

---

### Dispatchers

Commandë¥¼ ì „ì†¡í•˜ëŠ” ë‘ ê°€ì§€ ë°©ë²•ì´ ìˆë‹¤:

- CommandBus: low levelì—ì„œ ì»¤ìŠ¤í„°ë§ˆì´ì§•
- CommandGateway: high level, ëŒ€ë¶€ë¶„ì˜ ì¼ë°˜ì ì¸ ê²½ìš° ì‚¬ìš©

#### CommandGateway ì£¼ìš” ë©”ì„œë“œ

- `send`: ë¹„ë™ê¸° ì „ì†¡
- `sendAll`: ì—¬ëŸ¬ ì»¤ë§¨ë“œ ì¼ê´„ ì „ì†¡
- `sendAndWait`: ë™ê¸° ì „ì†¡
- configë¥¼ í†µí•œ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥

```kotlin
@Bean
fun commandGateway(commandBus: CommandBus): CommandGateway {
    return DefaultCommandGateway.builder()
        .commandBus(commandBus)
        .retryScheduler(IntervalRetryScheduler())
        .build()
}
```

### Aggregate

ë„ë©”ì¸ì—ì„œ ìœ ì‚¬í•œ entityì™€ value objectsì˜ ì§‘í•©ìœ¼ë¡œ, ì¼ê´€ì„± ìœ ì§€ ë° ë„ë©”ì¸ ë¡œì§ì„ ìº¡ìŠí™”í•œë‹¤.

#### Lifecycle Operations

- apply: aggregateì˜ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸
- markDeleted: aggregate ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ ì²˜ë¦¬ (DB ì‚­ì œ X)
- createNew: ìƒˆë¡œìš´ aggregate ìƒì„± (sagaë‚˜ ë‹¤ë¥¸ Aggregate ìƒì„± ì‹œ)
- isLive: í˜„ì¬ aggregateê°€ replay ì¤‘ì¸ì§€ live ìƒíƒœì¸ì§€ (side effectê°€ ìˆëŠ” ê²½ìš° í™œìš©)

#### Multi-Entity Aggregate

Aggregate ì•ˆì˜ ì—¬ëŸ¬ Entityë¥¼ í¬í•¨í•˜ëŠ” ê²½ìš°ë‹¤.

- ê¸°ë³¸ì ìœ¼ë¡œ í•„ë“œëª…ìœ¼ë¡œ ë©”ì‹œì§€ ë¼ìš°íŒ… ê°€ëŠ¥
- í•˜ìœ„ ì—”í‹°í‹° ìì²´ì ìœ¼ë¡œ @CommandHandlerë¥¼ ê°€ì§ˆ ìˆ˜ ìˆì–´ Aggregateì˜ ëª…ë ¹ ì²˜ë¦¬ ë¶„ë‹´ ê°€ëŠ¥

```kotlin
@Aggregate
class GiftCardAggregate() {

    @AggregateIdentifier
    lateinit var cardId: String

    var balance: Int = 0

    @AggregateMember
    var transactions: MutableList<GiftCardTransaction> = mutableListOf()
    
    // ... ìƒëµ
}

class GiftCardTransaction() {

    @EntityId
    lateinit var transactionId: String
    var amount: Int = 0
    var reimbursed: Boolean = false

    constructor(transactionId: String, amount: Int) : this() {
        this.transactionId = transactionId
        this.amount = amount
    }

    @CommandHandler
    fun handle(cmd: ReimburseTransactionCommand) {
        if (reimbursed) throw IllegalStateException("Already reimbursed")
        AggregateLifecycle.apply(GiftCardTransactionReimbursedEvent(cmd.cardId, transactionId))
    }

    @EventSourcingHandler
    fun on(event: GiftCardTransactionReimbursedEvent) {
        reimbursed = true
    }
}
```

#### State-Stored Aggregate

Event Sourcingì˜ ì´ì ì´ ì ê±°ë‚˜ ë³€ê²½ì´ ì ì€ ë„ë©”ì¸ì˜ ê²½ìš° ì‚¬ìš©í•œë‹¤.

- DBì— í˜„ì¬ ìƒíƒœë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥í•˜ê³  ì‚¬ìš©

```kotlin
import jakarta.persistence.*
import org.axonframework.commandhandling.CommandHandler
import org.axonframework.modelling.command.AggregateIdentifier
import org.axonframework.spring.stereotype.Aggregate

@Entity
@Aggregate
class GiftCardStateStoredAggregate(

    @Id
    @AggregateIdentifier
    var id: String? = null,

    var balance: Int = 0
) {

    @CommandHandler
    constructor(cmd: IssueGiftCardCommand) : this() {
        if (cmd.initialBalance < 0) throw IllegalArgumentException("Initial balance must be positive")
        id = cmd.cardId
        balance = cmd.initialBalance
    }

    @CommandHandler
    fun handle(cmd: RedeemGiftCardCommand) {
        if (cmd.amount > balance) throw IllegalArgumentException("Not enough balance")
        balance -= cmd.amount
    }
}
```

#### Aggregate Polymorphism

ê³µí†µëœ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìƒì†ì´ ê°€ëŠ¥í•˜ë‹¤.

```kotlin
abstract class PaymentAggregateBase { ... }
class CardPaymentAggregate : PaymentAggregateBase() { ... }
class BankTransferAggregate : PaymentAggregateBase() { ... }
```

#### Conflict Resolution

ë™ì¼í•œ aggregateì—ì„œ ì—¬ëŸ¬ ì»¤ë§¨ë“œê°€ ë³‘ë ¬ ì²˜ë¦¬ë  ë•Œ ì¶©ëŒì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

- Axonì€ ê¸°ë³¸ì ìœ¼ë¡œ Optimistic Lock ì‚¬ìš©
- ì¶©ëŒ ì‹œ ConcurrencyException ë°œìƒ
- ConflictResolverë¥¼ í†µí•´ í•´ê²°

```kotlin
@CommandHandler
fun handle(cmd: ChangeProductPriceCommand, conflictResolver: ConflictResolver) {
    // ì´ì „ì— ëˆ„ê°€ ì´ë¦„ì„ ë³€ê²½í–ˆëŠ”ì§€ ê²€ì‚¬
    conflictResolver.detectConflicts { events ->
        events.filterIsInstance<ProductRenamedEvent>()
            .firstOrNull { it.name.contains("ë¹„ì†ì–´") }?.let {
                throw IllegalStateException("ë¹„ì†ì–´ê°€ í¬í•¨ëœ ì´ë¦„ìœ¼ë¡œ ë³€ê²½ë¨")
            }
    }

    apply(ProductPriceChangedEvent(cmd.productId, cmd.newPrice))
}
```

#### Command Interceptor ì˜ˆì œ

Command Dispatch Interceptor (ë©”ì‹œì§€ ì „ì†¡ ì§í›„)

```kotlin
import org.axonframework.messaging.MessageDispatchInterceptor
import org.axonframework.commandhandling.CommandMessage
import org.springframework.stereotype.Component
import java.util.function.BiFunction

@Component
class LoggingCommandInterceptor : MessageDispatchInterceptor<CommandMessage<*>> {
    override fun handle(messages: MutableList<out CommandMessage<*>>): BiFunction<Int, CommandMessage<*>, CommandMessage<*>> {
        return BiFunction { index, command ->
            println("ğŸ“¦ [Command Interceptor] Command intercepted [${command.payloadType.simpleName}]: ${command.payload}")
            command
        }
    }
}
```

Command Handler Interceptor (í•¸ë“¤ëŸ¬ ì²˜ë¦¬ ì „í›„)

```kotlin
import org.axonframework.commandhandling.CommandHandlerInterceptor
import org.axonframework.messaging.InterceptorChain
import org.axonframework.messaging.unitofwork.UnitOfWork
import org.axonframework.commandhandling.CommandMessage
import org.springframework.stereotype.Component

@Component
class LoggingCommandHandlerInterceptor : CommandHandlerInterceptor<Any> {

    override fun handle(
        unitOfWork: UnitOfWork<out CommandMessage<*>>,
        interceptorChain: InterceptorChain
    ): Any {
        val command = unitOfWork.message.payload
        println("â¡ï¸ [HandlerInterceptor] ì²˜ë¦¬ ì‹œì‘: ${command::class.simpleName}")

        val result = interceptorChain.proceed() // ì‹¤ì œ CommandHandler ì‹¤í–‰

        println("âœ… [HandlerInterceptor] ì²˜ë¦¬ ì™„ë£Œ: ${command::class.simpleName}, ê²°ê³¼: $result")
        return result
    }
}
```

## Event

---

### Processing Group

í”„ë¡œì„¸ì‹± ê·¸ë£¹ì„ ì •ì˜í•˜ë©´, ê°™ì€ ê·¸ë£¹ ë‚´ì˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ ë°©ì‹ì„ ì œì–´í•  ìˆ˜ ìˆë‹¤.

- ê¸°ë³¸ì ìœ¼ë¡œ íŒ¨í‚¤ì§€ ì´ë¦„ìœ¼ë¡œ í”„ë¡œì„¸ì‹± ê·¸ë£¹ì´ ì„¤ì •ë¨
- `@ProcessingGroup`ìœ¼ë¡œ ëª…ì‹œí•˜ëŠ” ê²ƒì„ ê¶Œì¥
- ê°™ì€ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•  ë•Œ ìˆœì„œê°€ ì¤‘ìš”í•œ ê²½ìš° íŠ¹íˆ ìœ ìš©
- ë¹„ì¦ˆë‹ˆìŠ¤ ëª©ì /ê¸°ëŠ¥ ë‹¨ìœ„ë¡œ êµ¬ì„±

ê°™ì€ í”„ë¡œì„¸ì‹± ê·¸ë£¹ì˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ëŠ” ë“±ë¡ ìˆœì„œì— ë”°ë¼ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥í•˜ë‹¤.

#### ì´ë²¤íŠ¸ í”„ë¡œì„¸ì‹± ê·¸ë£¹ ë™ì‘ ë°©ì‹

1. Subscribing: ì‹¤ì‹œê°„ ë™ê¸° ì²˜ë¦¬ (ë¦¬í”Œë ˆì´ ë¶ˆê°€ëŠ¥)
- ë¦¬í”Œë ˆì´ê°€ í•„ìš” ì—†ì´ ì¦‰ì‹œ ì‹¤í–‰í•˜ëŠ” ê²ƒë“¤
- Slack, Push, Logging ë“±ì— ì í•©

2. Streaming: ë¹„ë™ê¸° ì²˜ë¦¬ (ë¦¬í”Œë ˆì´ ê°€ëŠ¥)

ë™ì‘ ë°©ì‹:
- StreamableMessageSourceë¡œë¶€í„° ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ì„ ì—´ì–´ ì´ë²¤íŠ¸ë¥¼ ë°›ì•„ì˜´
- ë³„ë„ì˜ ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ë¯€ë¡œ, ì´ë²¤íŠ¸ ë°œí–‰ê³¼ ì²˜ë¦¬ê°€ ë¶„ë¦¬
- Tracking Tokenì„ ì‚¬ìš©í•˜ì—¬ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ì—ì„œì˜ ì²˜ë¦¬ ìœ„ì¹˜ë¥¼ ì¶”ì 
- ì´ë¥¼ í†µí•´ ì¤‘ë‹¨ëœ ì´í›„ ì¬ì‹œì‘í•˜ê±°ë‚˜ ì´ë²¤íŠ¸ ì¬ì²˜ë¦¬(Replay) ê°€ëŠ¥
- ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ì§€ì›í•˜ì—¬ ì„±ëŠ¥ í™•ì¥ì´ ìš©ì´

ì£¼ìš” íŠ¹ì§•:
- ë¶„ë¦¬ëœ ìŠ¤ë ˆë“œ ì‚¬ìš©: ì´ë²¤íŠ¸ ë°œí–‰ê³¼ ì²˜ë¦¬ê°€ ë¶„ë¦¬ë˜ì–´ ìˆì–´, ì‹œìŠ¤í…œì˜ ë‹¤ë¥¸ ì‘ì—…ê³¼ ë…ë¦½ì ìœ¼ë¡œ ì´ë²¤íŠ¸ ì²˜ë¦¬
- ì²˜ë¦¬ ìœ„ì¹˜ ì¶”ì : Tracking Tokenì„ í†µí•´ í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ì´ë²¤íŠ¸ì˜ ìœ„ì¹˜ë¥¼ ì¶”ì í•˜ì—¬, ì¤‘ë‹¨ëœ ê²½ìš°ì—ë„ ì´ì–´ì„œ ì²˜ë¦¬
- ì´ë²¤íŠ¸ ì¬ì²˜ë¦¬ ì§€ì›: íŠ¹ì • ì‹œì ë¶€í„° ì´ë²¤íŠ¸ë¥¼ ë‹¤ì‹œ ì²˜ë¦¬í•  ìˆ˜ ìˆì–´, ì‹œìŠ¤í…œì˜ ìƒíƒœë¥¼ ì¬êµ¬ì„±í•˜ê±°ë‚˜ ì˜¤ë¥˜ë¥¼ ë³µêµ¬í•˜ëŠ”ë° ìœ ìš©
- ë³‘ë ¬ ì²˜ë¦¬ ë° í™•ì¥ì„±: ì„¸ê·¸ë¨¼íŠ¸(Segment)ë¥¼ í™œìš©í•˜ì—¬ ì´ë²¤íŠ¸ë¥¼ ë³‘ë ¬ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆì–´, ì„±ëŠ¥ í–¥ìƒ ê°€ëŠ¥

Segment
- ì´ë²¤íŠ¸ë¥¼ ë³‘ë ¬ë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ì„ ë‚˜ëˆ„ëŠ” ë…¼ë¦¬ì  ì²˜ë¦¬ ë‹¨ìœ„
- í•´ì‹œ ê¸°ë°˜ íŒŒí‹°ì…˜ì´ë¼ íŠ¹ì • aggregateì˜ ê²½ìš° í•˜ë‚˜ì˜ segmentì—ì„œ ì²˜ë¦¬ë¨(ìˆœì„œ ë³´ì¥)
- Queueì™€ ë¹„ìŠ·í•œ ê°œë…

êµ¬í˜„ ì¢…ë¥˜:
- tracking ëª¨ë“œ(ë‹¨ì¼ ìŠ¤ë ˆë“œ) â†’ Axon ê¸°ë³¸ê°’
  - segment ì„¤ì •ì„ í†µí•´ ë©€í‹° ìŠ¤ë ˆë“œ ê°€ëŠ¥ (segment ìˆ˜ = thread ìˆ˜)
- pooled ëª¨ë“œ(ë©€í‹° ìŠ¤ë ˆë“œ, ì„±ëŠ¥ì— ì¢‹ìŒ)
  - ëŒ€ë¶€ë¶„ì˜ ìƒí™©ì— ì¶”ì²œë¨
  - segment-to-thread-count ë¹„ìœ¨, ìŠ¤ë ˆë“œ í’€ ê³µìœ  ëŠ¥ë ¥, ì ì€ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ ê°œìˆ˜ë¡œ ì¸í•œ ì¥ì 

#### ì„¤ì • ì˜ˆì œ

```yaml
axon:
  eventhandling:
    processors:
      user-view:
        mode: pooled
        initialSegmentCount: 10
        threadCount: 10 # ë³´í†µ segment countì™€ ë™ì¼í•˜ê²Œ
```

#### Dead Letter Queue (DLQ)

ì´ë²¤íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ê°€ ë°˜ë³µë  ê²½ìš°, í•´ë‹¹ ì´ë²¤íŠ¸ë¥¼ DLQë¡œ ë³´ë‚´ê³  ìŠ¤í‚µí•œë‹¤.

- í•´ë‹¹ DLQì—ì„œ Retry ì‹œë„ ê°€ëŠ¥
- [ê³µì‹ ë¬¸ì„œ ì°¸ì¡°](https://docs.axoniq.io/axon-framework-reference/4.11/events/event-processors/dead-letter-queue/)

#### Event Versioning

ì´ë²¤íŠ¸ ê³¼ê±° ë²„ì „ê³¼ í˜„ì¬ ë²„ì „ì˜ í˜¸í™˜ì„±ì„ ìœ„í•´ versioningì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```kotlin
@Revision("2")
data class UserCreatedEvent(
    val id: String,
    val name: String,
    val email: String
)
```

Upcast ì˜ˆì œ
```kotlin
@Component
class UserCreatedEventUpcaster : SingleEventUpcaster() {
    override fun canUpcast(eventRepresentation: IntermediateEventRepresentation): Boolean {
        return eventRepresentation.type.name == "UserCreatedEvent" &&
               eventRepresentation.revision.isEmpty
    }

    override fun doUpcast(eventRepresentation: IntermediateEventRepresentation): IntermediateEventRepresentation {
        return eventRepresentation.upcastPayload(
            Document.parse("""{"email":"unknown@example.com"}""")
        )
    }
}
```

## Metadata

---

| ì‚¬ìš© ì‚¬ë¡€ | ì„¤ëª… |
|-------------|---------|
| ğŸ§‘â€ğŸ’¼ ì‚¬ìš©ì ì •ë³´ ì „ë‹¬ | ì¸ì¦ëœ ì‚¬ìš©ì ID, ì—­í•  ë“± |
| ğŸ§ª íŠ¸ë ˆì´ì‹± / ë¡œê¹… | traceId, correlationId ë“± ë¶„ì‚° ì¶”ì ìš© |
| ğŸ§  ê°ì‹œ / ê°ì‚¬ ë¡œê·¸ | ì´ë²¤íŠ¸ ëˆ„ê°€ ë°œìƒì‹œì¼°ëŠ”ì§€ ê¸°ë¡ |
| ğŸ” Retry / ì¬ì‹œë„ ì •ì±… | ì¬ì‹œë„ íšŸìˆ˜ ê°™ì€ ê¸°ìˆ ì  ì†ì„± |
| ğŸ§¯ ì—ëŸ¬ ì²˜ë¦¬ | ì—ëŸ¬ ë°œìƒ ì§€ì  ì¶”ì  |

```kotlin
// write
val metadata = MetaData.with("userId", "user-123")
commandGateway.send(MyCommand(...), metadata)

// read
@EventHandler
fun on(event: OrderPlacedEvent, @MetaDataValue("userId") userId: String?) {
    println("ì´ ì´ë²¤íŠ¸ëŠ” $userId ê°€ ë°œìƒì‹œì¼°ìŠµë‹ˆë‹¤.")
}
```

## Query Handler

---

Axonì—ì„œëŠ” ë‹¤ì–‘í•œ ì¿¼ë¦¬ ì²˜ë¦¬ ë°©ì‹ì„ ì§€ì›í•œë‹¤:

- point-to-point: ì¼ë°˜ì ì¸ ì¡°íšŒ ë°©ì‹
- scatter-gather: ì—¬ëŸ¬ í•¸ë“¤ëŸ¬ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ë³‘í•©
- subscription: ì´ˆê¸° ìƒíƒœ ì¡°íšŒ í›„, í•´ë‹¹ ìƒíƒœì˜ ë³€ê²½ì„ ì§€ì†ì ìœ¼ë¡œ ìˆ˜ì‹ , ìƒíƒœ ë³€ê²½ ì‹œ QueryUpdateEmitter ì‚¬ìš©
- streaming: ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¥¼ ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ê°€ ë°ì´í„°ë¥¼ ì ì§„ì ìœ¼ë¡œ ìˆ˜ì‹ í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë°©ì‹, ë©”ëª¨ë¦¬ ìµœì í™” ë° ì§€ì—° ì‹œê°„ ê°ì†Œ

## Saga

---

ì¥ê¸° ì‹¤í–‰ í”„ë¡œì„¸ìŠ¤(Long-lived business process)ë¥¼ êµ¬í˜„í•  ë•Œ ì‚¬ìš©í•˜ëŠ” í•µì‹¬ ê°œë…ì´ë‹¤.

- ì—¬ëŸ¬ ë‹¨ê³„ì˜ ì‘ì—…(ì´ë²¤íŠ¸)ì„ ì²˜ë¦¬í•˜ëŠ”ë° ì í•©, ë³´ìƒ íŠ¸ëœì­ì…˜ ì§€ì›
- `saga_entry` DBì— ì €ì¥ë˜ê¸° ë•Œë¬¸ì— ì¶”ì ì— ìš©ì´

```kotlin
@Saga
class OrderManagementSaga {

    @Autowired
    private lateinit var deadlineManager: DeadlineManager

    @Autowired
    private lateinit var commandGateway: CommandGateway

    private var deadlineId: String? = null

    @StartSaga
    @SagaEventHandler(associationProperty = "orderId")
    fun on(event: OrderPlacedEvent) {
        println("ğŸ“¦ ì£¼ë¬¸ ì ‘ìˆ˜ - Saga ì‹œì‘")

        // orderIdë¥¼ ê¸°ì¤€ìœ¼ë¡œ Saga ì¸ìŠ¤í„´ìŠ¤ì— ì´ë²¤íŠ¸ ë¼ìš°íŒ… ì—°ê²°
        associateWith("orderId", event.orderId)

        // 15ë¶„ ì•ˆì— ê²°ì œ ì•ˆ ë˜ë©´ ì£¼ë¬¸ ì·¨ì†Œ
        deadlineId = deadlineManager.schedule(
            Duration.ofMinutes(15),
            "payment-deadline",
            event.orderId
        )
    }

    @SagaEventHandler(associationProperty = "orderId")
    fun on(event: PaymentConfirmedEvent) {
        println("ğŸ’³ ê²°ì œ ì™„ë£Œ - ë°°ì†¡ ì‹œì‘")
        
        // shipmentIdë¥¼ ê¸°ì¤€ìœ¼ë¡œ Saga ì¸ìŠ¤í„´ìŠ¤ì— ì´ë²¤íŠ¸ ë¼ìš°íŒ… ì—°ê²° ì¶”ê°€
        associateWith("shipmentId", event.shipmentId)

        // ê²°ì œ ì™„ë£Œë˜ë©´ ì˜ˆì•½ëœ deadline ì·¨ì†Œ
        deadlineId?.let {
            deadlineManager.cancelSchedule("payment-deadline", it)
        }

        commandGateway.send(StartDeliveryCommand(event.orderId))
    }
    
    @SagaEventHandler(associationProperty = "orderId")
    fun on(event: PaymentFailedEvent) {
        println("ğŸ’¥ ê²°ì œ ì‹¤íŒ¨ - ì£¼ë¬¸ ì·¨ì†Œ ë³´ìƒ íŠ¸ëœì­ì…˜ ì‹¤í–‰")
        val command = CancelOrderCommand(event.orderId)
        commandGateway.send(command)
    }

    @EndSaga
    @SagaEventHandler(associationProperty = "orderId")
    fun on(event: OrderCancelledEvent) {
    }

    @SagaEventHandler(associationProperty = "shipmentId")
    @EndSaga
    fun on(event: DeliveryCompletedEvent) {
        println("ğŸšš ë°°ì†¡ ì™„ë£Œ - Saga ì¢…ë£Œ")
    }

    @DeadlineHandler(deadlineName = "payment-deadline")
    fun handlePaymentTimeout(orderId: String) {
        println("â° ê²°ì œ ê¸°í•œ ì´ˆê³¼ - ì£¼ë¬¸ ì·¨ì†Œ")

        commandGateway.send(CancelOrderCommand(orderId))
    }
}
```

### ì£¼ìš” ê°œë…

- `associationProperty`: Saga ì´ë²¤íŠ¸ ìˆ˜ì‹ ì„ ìœ„í•œ key
  - `associateWith`: saga associate key ì¶”ê°€
  - `removeAssociationWith`: saga associate key ì œê±°
- `DeadlineManager`: ì¼ì • ì‹œê°„ì´ ì§€ë‚œ í›„ íŠ¹ì • ì‘ì—…ì„ ìˆ˜í–‰

## Tuning

---

ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ì£¼ìš” ê¸°ëŠ¥ë“¤:

- Event Snapshots: ì´ë²¤íŠ¸ ìŠ¤í† ì–´ì—ì„œ aggregate ì¬êµ¬ì„± ì‹œ ì„±ëŠ¥ í–¥ìƒ
- Cache: ìì£¼ ì‚¬ìš©ë˜ëŠ” aggregateë‚˜ projection ë°ì´í„° ìºì‹±

## ë§ˆì¹˜ë©°

---

&nbsp;&nbsp;&nbsp;Axon FrameworkëŠ” Event Sourcingê³¼ CQRS íŒ¨í„´ì„ êµ¬í˜„í•˜ëŠ”ë° ìˆì–´ ë§¤ìš° ê°•ë ¥í•˜ê³  í¬ê´„ì ì¸ ë„êµ¬ë‹¤. ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì´ë²¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ë¶„í•´í•˜ê³ , í™•ì¥ ê°€ëŠ¥í•œ ì•„í‚¤í…ì²˜ë¥¼ êµ¬ì„±í•˜ëŠ”ë° í° ë„ì›€ì´ ëœë‹¤. íŠ¹íˆ MSA í™˜ê²½ì—ì„œ ì„œë¹„ìŠ¤ ê°„ ì¼ê´€ì„± ìœ ì§€ì™€ ì¥ê¸° ì‹¤í–‰ í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬ì— íƒì›”í•œ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.

&nbsp;&nbsp;&nbsp;í•˜ì§€ë§Œ Event Sourcingê³¼ CQRS ìì²´ê°€ ë³µì¡í•œ íŒ¨í„´ì´ë¯€ë¡œ, ë„ì… ì „ì— ì¶©ë¶„í•œ í•™ìŠµê³¼ íŒ€ ë‚´ í•©ì˜ê°€ í•„ìš”í•˜ë‹¤. ë˜í•œ ê¸°ì¡´ CRUD ë°©ì‹ì— ìµìˆ™í•œ ê°œë°œìë“¤ì—ê²ŒëŠ” ëŸ¬ë‹ ì»¤ë¸Œê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ, ë‹¨ê³„ì ìœ¼ë¡œ ì ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤.
